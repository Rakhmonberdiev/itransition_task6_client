@if(connected()){
<ng-container>
  <div class="h-screen flex bg-gray-100">
    <aside class="w-1/5 shadow-2xl bg-white p-6 overflow-auto hidden lg:block">
      <h2 class="text-2xl font-semibold mb-4">Participants</h2>
      <ul class="space-y-3">
        @for (u of users(); track $index) {
        <li
          class="flex items-center justify-between p-2 bg-gray-50 rounded-lg shadow-md hover:bg-gray-100 min-h-[64px]"
        >
          <span [class.font-bold]="u.name === userService.user()?.name">
            {{ u.name }} ({{ u.role }})
          </span>
          @if(role() === 'creator' && u.role !== 'creator'){
          <button
            class="text-xs bg-slate-500 text-white px-4 py-2 cursor-pointer rounded-md hover:bg-slate-700 duration-200 hover:scale-110"
            (click)="
              changeRole(u.name, u.role === 'viewer' ? 'editor' : 'viewer')
            "
          >
            {{ u.role === "viewer" ? "Make editor" : "Make a viewer" }}
          </button>
          }
        </li>
        }
      </ul>
    </aside>
    <main class="flex-1 p-6 overflow-auto">
      <div class="flex justify-between items-center mb-6">
        <h1 class="text-3xl font-bold">Slides</h1>
        @if(role()==='creator'){
        <button
          class="bg-slate-500 text-white gap-1 px-4 py-2 cursor-pointer tracking-widest rounded-md hover:bg-slate-400 duration-200 hover:scale-110"
          (click)="addSlide()"
        >
          New slide
        </button>
        }
      </div>

      <div class="grid grid-cols-1 gap-6">
        @for (slide of slides(); track slide.id) {
        <h2 class="text-xl font-semibold mb-4">Slide {{ $index + 1 }}</h2>
        <div
          id="slide-{{ slide.id }}"
          class="relative bg-white h-128 rounded shadow-md mb-4 overflow-hidden"
        >
          @for (el of elements()[slide.id]; track $index) {
          <ng-container>
            <div
              class="absolute group transition-transform duration-75"
              cdkDrag
              [cdkDragDisabled]="role() === 'viewer'"
              [class.cursor-move]="role() !== 'viewer'"
              [cdkDragBoundary]="'#slide-' + slide.id"
              [cdkDragFreeDragPosition]="{ x: el.x, y: el.y }"
              (cdkDragStarted)="selectElement(el.id, slide.id)"
              (cdkDragEnded)="onDragEnded($event, slide.id, el)"
              [class.duration-500]="role() === 'viewer'"
              [class.gradient-border]="
                role() !== 'viewer' &&
                selectedElementId() === el.id &&
                !editingElementId()
              "
            >
              @if(isTextBlock(el)){ @if(editingElementId()===el.id){
              <div class="flex items-center space-x-2 bg-white p-1">
                <div class="relative w-60 group">
                  <span
                    class="absolute -left-0.5 top-2 bottom-2 w-1.5 rounded bg-gradient-to-b from-indigo-500 to-purple-500 opacity-70 transition-all duration-300 group-focus-within:opacity-100"
                  ></span>
                  <input
                    type="text"
                    id="input"
                    [value]="editingText()"
                    (input)="editingText.set($any($event.target).value)"
                    placeholder=""
                    class="peer w-full p-4 text-sm text-gray-800 bg-white border border-gray-200 rounded-lg shadow-md focus:border-transparent focus:ring-2 focus:ring-indigo-300 focus:outline-none transition-all duration-300 delay-200 placeholder-transparent"
                  />
                </div>

                <button
                  class="text-xs bg-slate-500 text-white px-4 p-2 cursor-pointer rounded-md hover:bg-slate-400 duration-200 hover:scale-110"
                  (click)="saveTextEdit(slide.id)"
                >
                  OK
                </button>
                <button
                  class="text-xs bg-red-500 text-white px-4 py-2 cursor-pointer rounded-md hover:bg-red-400 duration-200 hover:scale-110"
                  (click)="cancelTextEdit()"
                >
                  ✕
                </button>
              </div>
              }@else {
              <p
                class="p-2"
                [style.left.px]="el.x"
                [style.top.px]="el.y"
                [style.fontSize.px]="el.fontSize"
                [style.fontFamily]="el.fontFamily"
                [style.color]="el.color"
              >
                {{ el.text }}
              </p>
              } } @if(isImageBlock(el)){
              <img
                class="p-2 max-w-100"
                [src]="el.url"
                [style.left.px]="el.x"
                [style.top.px]="el.y"
                [alt]="el.url"
              />
              } @if(role() !== 'viewer' && !editingElementId()){
              <button
                (click)="removeElement(slide.id, el.id)"
                class="absolute -top-2 -right-2 w-6 h-6 bg-red-600 text-white rounded-full text-xs opacity-100 md:opacity-0 cursor-pointer group-hover:opacity-100 transition-all duration-200 hover:scale-110"
              >
                ✕
              </button>
              @if(role() !== 'viewer' && isTextBlock(el)){
              <button
                (click)="startEditingTextBlock(slide.id, el)"
                class="absolute -top-2 -left-2 bg-slate-500 p-1 text-xs text-white cursor-pointer opacity-100 md:opacity-0 group-hover:opacity-100 rounded-full hover:bg-slate-400 duration-200 hover:scale-110"
                title="Edit text"
              >
                ✏️
              </button>
              } }
            </div>
          </ng-container>

          }
        </div>
        <div class="relative p-4">
          @if(role() !== 'viewer'){
          <button
            class="px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600"
            (click)="addTextBlock(slide.id)"
          >
            New text
          </button>
          <div class="image-input mt-3">
            @if(!imageLoading()){
            <div class="rounded-lg w-64">
              <div
                class="relative h-64 rounded-lg border-2 border-blue-500 bg-gray-50 flex justify-center items-center shadow-lg hover:shadow-xl transition-shadow duration-300 ease-in-out"
              >
                <div class="absolute flex flex-col items-center">
                  <img alt="File Icon" class="mb-3" src="images/file.png" />
                  <span class="block text-gray-500 font-semibold"
                    >Drag &amp; drop your files here</span
                  >
                  <span class="block text-gray-400 font-normal mt-1"
                    >or click to upload</span
                  >
                </div>

                <input
                  class="h-full w-full opacity-0 cursor-pointer"
                  type="file"
                  accept="image/*"
                  (change)="onFileSelected($event, slide.id)"
                />
              </div>
            </div>
            }@else {
            <p>Image loading…</p>
            }
          </div>
          }
        </div>
        }
      </div>
    </main>
  </div>
</ng-container>
}@else {
<ng-template>
  <div class="h-screen flex items-center justify-center bg-gray-100">
    <p class="text-gray-600 text-lg">Loading…</p>
  </div>
</ng-template>
}
